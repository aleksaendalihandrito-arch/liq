from websocket import WebSocketApp
import json
import time
import requests
import os  # –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –ë–ï–†–ï–ú –ò–ó –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', '7572230525:AAFzAQsMe4DlTYAA8G5UgGnYH598ZxgZOjs')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID', '5296533274')
LIQUIDATION_THRESHOLD = int(os.environ.get('LIQUIDATION_THRESHOLD', 50000))
TEST_MODE = os.environ.get('TEST_MODE', 'False').lower() == 'true'

# –¢–æ–ø-25 –º–æ–Ω–µ—Ç –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
TOP_25_COINS = {
    'BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'XRPUSDT',
    'ADAUSDT', 'DOGEUSDT', 'AVAXUSDT', 'DOTUSDT', 'LINKUSDT',
    'MATICUSDT', 'SHIBUSDT', 'LTCUSDT', 'BCHUSDT', 'ATOMUSDT',
    'UNIUSDT', 'XLMUSDT', 'XMRUSDT', 'ETCUSDT', 'FILUSDT',
    'APTUSDT', 'HBARUSDT', 'NEARUSDT', 'VETUSDT', 'OPUSDT', 'BTCUSDC'
}

def log(message):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"[{timestamp}] {message}", flush=True)  # –î–æ–±–∞–≤–ª—è–µ–º flush=True –¥–ª—è Railway

def generate_links(symbol):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã"""
    clean_symbol = symbol.replace('USDT', '').replace('1000', '')
    return {
        'coinglass': f"https://www.coinglass.com/pro/futures/LiquidationHeatMapModel3?coin={clean_symbol}&type=pair",
        'tradingview': f"https://www.tradingview.com/chart/?symbol=BINANCE:{symbol}",
        'binance': f"https://www.binance.com/ru/trade/{symbol}",
        'bybit': f"https://www.bybit.com/trade/usdt/{symbol}"
    }

def send_telegram_alert(message, symbol):
    try:
        log(f"–û—Ç–ø—Ä–∞–≤–∫–∞: {message[:50]}...")

        links = generate_links(symbol)
        message_with_links = (
            f"{message}\n\n"
            f"üîó <b>–ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑:</b>\n"
            f"‚Ä¢ üìä <a href='{links['coinglass']}'>Coinglass</a>\n"
            f"‚Ä¢ üìà <a href='{links['tradingview']}'>TradingView</a>\n"
            f"‚Ä¢ üí∞ <a href='{links['binance']}'>Binance</a>\n"
            f"‚Ä¢ ‚ö° <a href='{links['bybit']}'>Bybit</a>"
        )

        monospace_symbol = f"<code>{symbol}</code>"
        message_with_links = message_with_links.replace(symbol, monospace_symbol)

        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {
            'chat_id': TELEGRAM_CHAT_ID,
            'text': message_with_links,
            'parse_mode': 'HTML',
            'disable_web_page_preview': False
        }
        response = requests.post(url, json=payload, timeout=10)
        response.raise_for_status()
        log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
        return True
    except Exception as e:
        log(f"–û–®–ò–ë–ö–ê Telegram: {str(e)}")
        return False

def is_top_coin(symbol):
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–Ω–µ—Ç–∞ —Ç–æ–ø-25"""
    return symbol in TOP_25_COINS

def on_message(ws, message):
    try:
        log(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: {message[:100]}...")
        data = json.loads(message)

        if TEST_MODE:
            log("–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: –æ—Ç–ø—Ä–∞–≤–∫–∞ fake-–ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏")
            test_message = (
                f"‚ö°Ô∏è <b>–¢–ï–°–¢–û–í–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</b>\n"
                f"–°—Ç–æ—Ä–æ–Ω–∞: üî¥ SHORT\n"
                f"–°—É–º–º–∞: $999,999\n"
                f"–í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}"
            )
            send_telegram_alert(test_message, "TESTUSDT")
            return

        if 'e' in data and data['e'] == 'forceOrder':
            liq = data['o']
            symbol = liq.get('s', 'UNKNOWN')

            if is_top_coin(symbol):
                log(f"–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ç–æ–ø-–º–æ–Ω–µ—Ç—É: {symbol}")
                return

            side = liq.get('S')
            quantity = float(liq.get('q', 0))
            price = float(liq.get('ap', 0))
            usd_value = quantity * price
            time_stamp = datetime.fromtimestamp(data.get('E', 0) / 1000).strftime('%H:%M:%S')

            log(f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {symbol} {side} ${usd_value:,.0f}")

            if side == 'BUY' and usd_value >= LIQUIDATION_THRESHOLD:
                msg = (
                    f"üìà <b>–†–æ—Å—Ç —Ü–µ–Ω—ã + –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è SHORT</b>\n"
                    f"–ú–æ–Ω–µ—Ç–∞: <code>{symbol}</code>\n"
                    f"üî¥ –õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–æ SHORT: <code>${usd_value:,.0f}</code>\n"
                    f"üí∞ –¶–µ–Ω–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏: <code>{price:.2f}</code>\n"
                    f"üïí –í—Ä–µ–º—è: <code>{time_stamp}</code>\n"
                    f"üìä –ù–µ —Ç–æ–ø-25 –º–æ–Ω–µ—Ç–∞"
                )
                send_telegram_alert(msg, symbol)
            else:
                if side != 'BUY':
                    log(f"–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º LONG –ª–∏–∫–≤–∏–¥–∞—Ü–∏—é (–ø–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã): {symbol}")
                else:
                    log("–õ–∏–∫–≤–∏–¥–∞—Ü–∏—è –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")

    except Exception as e:
        log(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {str(e)}")

def on_error(ws, error):
    log(f"–û–®–ò–ë–ö–ê WebSocket: {str(error)}")
    time.sleep(5)

def on_close(ws, close_status_code, close_msg):
    log(f"–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ö–æ–¥: {close_status_code}, –ü—Ä–∏—á–∏–Ω–∞: {close_msg}")
    time.sleep(2)

def on_open(ws):
    log("–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Binance WebSocket")
    send_telegram_alert(
        "üîå –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Binance\n\nüìà –û—Ç—Å–ª–µ–∂–∏–≤–∞—é SHORT –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç) –¥–ª—è –ù–ï —Ç–æ–ø-25 –º–æ–Ω–µ—Ç",
        "SYSTEM")
    if TEST_MODE:
        log("–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")

def connect_websocket():
    log("–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket...")
    while True:  # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        try:
            ws = WebSocketApp("wss://fstream.binance.com/ws/!forceOrder@arr",
                              on_open=on_open,
                              on_message=on_message,
                              on_error=on_error,
                              on_close=on_close)
            ws.run_forever()
        except Exception as e:
            log(f"–û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø: {str(e)}")
        log("–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
        time.sleep(5)

if __name__ == "__main__":
    log("=" * 50)
    log("–ó–ê–ü–£–°–ö –ë–û–¢–ê –õ–ò–ö–í–ò–î–ê–¶–ò–ô –ù–ê RAILWAY")
    log("=" * 50)
    log(f"–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –º–æ–Ω–µ—Ç—ã: {len(TOP_25_COINS)} —Ç–æ–ø–æ–≤—ã—Ö")
    log(f"–ü–æ—Ä–æ–≥ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏: ${LIQUIDATION_THRESHOLD}")
    log(f"–†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {TEST_MODE}")

    try:
        import websocket
        log("‚úì –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ websocket –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
    except ImportError as e:
        log(f"‚úó –û–®–ò–ë–ö–ê: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ - {str(e)}")
        exit(1)

    connect_websocket()
